<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë°˜ë³µ ê²€ìƒ‰ ë…¸ì˜ˆ, GPT</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

  body {
    font-family: 'Roboto', sans-serif;
    background: #f5f7fa;
    margin: 0; padding: 20px;
    display: flex;
    justify-content: center;
  }
  .container {
    background: white;
    width: 100%;
    max-width: 720px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    padding: 30px 40px;
  }
  h1 {
    margin-top: 0;
    font-weight: 700;
    color: #222;
    text-align: center;
    margin-bottom: 30px;
  }

  label {
    font-weight: 600;
    margin-top: 20px;
    display: block;
    color: #444;
    user-select: none;
  }

  input[type="text"], textarea {
    width: 100%;
    border: 1.8px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    padding: 12px 16px;
    margin-top: 8px;
    resize: vertical;
    transition: border-color 0.3s ease;
    font-family: 'Roboto', sans-serif;
  }
  input[type="text"]:focus, textarea:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 6px rgba(0, 123, 255, 0.3);
  }

  button {
    margin-top: 24px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 14px 22px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.25s ease;
    user-select: none;
    display: block;
    width: 100%;
  }
  button:hover:not(:disabled) {
    background-color: #0056b3;
  }
  button:disabled {
    background-color: #a0c8ff;
    cursor: default;
  }

  #console {
    background: #1e1e1e;
    color: #d4d4d4;
    height: 140px;
    overflow-y: auto;
    padding: 14px 18px;
    margin-top: 20px;
    border-radius: 8px;
    font-family: 'Source Code Pro', monospace, monospace;
    white-space: pre-wrap;
  }

  #excelDownload {
    margin-top: 20px;
    display: none;
  }

  #dropZone {
    margin-top: 16px;
    padding: 30px;
    border: 3px dashed #bbb;
    border-radius: 12px;
    text-align: center;
    color: #999;
    font-weight: 500;
    font-size: 16px;
    transition: background-color 0.3s, border-color 0.3s, color 0.3s;
    user-select: none;
    cursor: pointer;
  }
  #dropZone.dragover {
    background-color: #e6f0ff;
    border-color: #007bff;
    color: #007bff;
  }

  /* ë°˜ì‘í˜• */
  @media (max-width: 480px) {
    .container {
      padding: 20px;
    }
    button {
      padding: 12px 18px;
      font-size: 14px;
    }
  }

/* âœ…ëª¨ë¸ë³„ ê°€ê²©ë¶€ë¶„ */
.tooltip {
  position: relative;
  display: inline-block;
  margin-left: 8px;
  color: #555;
  font-size: 0.85em;
  cursor: help;
  user-select: none;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 180px;
  background-color: #333;
  color: #fff;
  text-align: left;
  border-radius: 6px;
  padding: 8px;
  position: absolute;
  z-index: 100;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 0.75em;
  line-height: 1.3em;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
</style>
</head>
<body>

<div class="container">
  <h1>ë°˜ë³µ ê²€ìƒ‰ ë…¸ì˜ˆ, GPT</h1>

  <label for="apiKey">OpenAI API í‚¤</label>
  <input type="text" id="apiKey" placeholder="ì˜ˆ: sk-..." autocomplete="off" />

<label for="modelName">ì‚¬ìš©í•  ëª¨ë¸ ì´ë¦„</label>
<span class="tooltip">ëª¨ë¸ë³„ ê°€ê²©
  <span class="tooltiptext">
    2025-05 ê¸°ì¤€ ëª¨ë¸ë³„ ìƒëŒ€ ê°€ê²©<br>
    - gpt-4o-mini: 1(ê¸°ì¤€)<br>
    - gpt-4o: ì•½ 16.7ë°°<br>
    - gpt-4: ì•½ 2ë°°<br>
    - gpt-4.5: ì•½ 500ë°°<br>
    - gpt-3.5-turbo: ì•½ 0.01ë°°
  </span>
</span>

<input type="text" id="modelName" placeholder="ì˜ˆ: gpt-4o-mini" autocomplete="off" />

  <label for="SearchArea">ê²€ìƒ‰ë¶„ì•¼</label>
  <input type="text" id="searcharea" placeholder="ì˜ˆ: ìƒëª…ê³¼í•™ - ìœ ì „ì" autocomplete="off" />

  <label for="searchList">ê²€ìƒ‰ ëŒ€ìƒ ëª©ë¡ (Input Items)<br><small>í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš” ë˜ëŠ” ì•„ë˜ì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</small></label>
  <textarea id="searchList" rows="6" placeholder="ì˜ˆ:&#10;ê²€ìƒ‰ì–´1&#10;ê²€ìƒ‰ì–´2&#10;ê²€ìƒ‰ì–´3"></textarea>



  <div id="dropZone" tabindex="0" aria-label="íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­, í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ txt íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>

  <label for="targetFields">ê²€ìƒ‰ í•­ëª©<br><small>ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”</small></label>
  <textarea id="targetFields" rows="6" placeholder="ì˜ˆ:&#10;ê¸°ëŠ¥&#10;ì¡°ì§ ì†ìƒ ì—¬ë¶€(True/False)&#10;ë°œí˜„ ë©”ì»¤ë‹ˆì¦˜"></textarea>

  <button id="generatePromptBtn" type="button">í”„ë¡¬í”„íŠ¸ ì‘ì„±</button>

  <label for="promptBox">ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ (ìˆ˜ì • ê°€ëŠ¥)</label>
  <textarea id="promptBox" rows="8" placeholder="ì—¬ê¸°ì— ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤."></textarea>

  <button id="sendToGptBtn" type="button">GPTì— ì „ì†¡</button>

  <div id="console" aria-live="polite" role="log" aria-atomic="true"></div>

  <button id="csvDownload" type="button" style="display:none;">csvë¡œ ë‹¤ìš´ë°›ê¸°</button>
</div>

<script>
  const geneListTextarea = document.getElementById('geneList');
  const dropZone = document.getElementById('dropZone');

  function readFile(file) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      geneListTextarea.value = evt.target.result;
    };
    reader.readAsText(file, 'utf-8');
  }

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length === 0) return;
    const file = e.dataTransfer.files[0];
    if (file.type === "text/plain" || file.name.endsWith('.txt')) {
      readFile(file);
    } else {
      alert('txt íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }
  });

  // í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
  dropZone.addEventListener('click', () => {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.txt,text/plain';
    fileInput.onchange = (e) => {
      if (fileInput.files.length === 0) return;
      const file = fileInput.files[0];
      if (file.type === "text/plain" || file.name.endsWith('.txt')) {
        readFile(file);
      } else {
        alert('txt íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      }
    };
    fileInput.click();
  });

  // í‚¤ë³´ë“œ ì ‘ê·¼ì„±: Enter, Space í‚¤ ëˆŒë €ì„ ë•Œ í´ë¦­ê³¼ ë™ì¼ ë™ì‘
  dropZone.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      dropZone.click();
    }
  });

</script>

<script>
// âœ…
// âœ…
// âœ…
// âœ…í†µí•©ë³¸ ìë°”ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì‚½ì…ë¨
// âœ…
// âœ…
// âœ…
// âœ…



// âœ…íŒŒì¼ì„ ì½ì–´ì„œ í…ìŠ¤íŠ¸ ì˜ì—­(textarea)ì— ë‚´ìš©ì„ ë„£ëŠ” ê¸°ëŠ¥
const searchListTextarea = document.getElementById('searchList');

function readFile(file) {
  const reader = new FileReader();
  reader.onload = function(evt) {
    searchListTextarea.value = evt.target.result;
  };
  reader.readAsText(file, 'utf-8');
}





// âœ… ì½˜ì†” ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
function logToConsole(message) {
  const consoleEl = document.getElementById("console");
  consoleEl.textContent += `\n${message}`;
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

// âœ… CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ë™ì  í—¤ë” êµ¬ì„±)
function downloadCSV() {
  const targetFields = document.getElementById("targetFields").value.trim().split(/\n+/);
  const header = ["ê²€ìƒ‰ì–´", ...targetFields];

  const searchItems = document.getElementById("searchList").value.trim().split(/\n+/);

  const rows = [header];

  for (let i = 0; i < geneData.length; i++) {
    const geneName = searchItems[i] || "ì •ë³´ì—†ìŒ";
    const values = geneData[i];
    rows.push([geneName, ...values]);
  }

  const csvContent = "\uFEFF" + rows.map(row => row.join(",")).join("\n");  // BOM ì¶”ê°€

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "search_info.csv";
  a.click();
  URL.revokeObjectURL(url);
}




// âœ… ë³€ìˆ˜ ë° ì´ë²¤íŠ¸ ë“±ë¡
const searchListEl = document.getElementById("searchList");
const promptBox = document.getElementById("promptBox");
const generatePromptBtn = document.getElementById("generatePromptBtn");
const sendToGptBtn = document.getElementById("sendToGptBtn");
const downloadBtn = document.getElementById("csvDownload");




// âœ… GPT ì‘ë‹µ ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ë°°ì—´ (CSV ì €ì¥ìš©)
let geneData = [];





// âœ… í”„ë¡¬í”„íŠ¸ ìƒì„±
generatePromptBtn.addEventListener("click", () => {
  const targets = document.getElementById("targetFields").value.trim().split(/\n+/);
  if (targets.length === 1 && targets[0] === "") return;

  const searchArea = document.getElementById("searcharea").value.trim();
  const headerLine = ["input items", ...targets].join(", ");

  const template = `${searchArea}({input items})ì— ëŒ€í•´ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìŠ¬ë˜ì‹œ(/////) ì‚¬ì´ì˜ ì •ë³´ë¥¼ CSV(ì½¤ë§ˆë¡œ êµ¬ë¶„) í˜•íƒœë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”.
/////
${headerLine}
///////
- ê° í•­ëª©ì€ ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.
- ê° í•­ëª© ë‚´ë¶€ì—ëŠ” ì½¤ë§ˆê°€ ë“¤ì–´ê°€ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.
- ëª¨ë“  ë‚´ìš©ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤. (ë‹¨, ì˜ˆì‹œì²˜ëŸ¼ ì˜ì–´ ì•½ì–´(F, T ë“±)ëŠ” í—ˆìš©ë©ë‹ˆë‹¤)
- ë¶ˆëª…í™•í•˜ê±°ë‚˜ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ” 'ì •ë³´ì—†ìŒ'ìœ¼ë¡œ í‘œê¸°í•˜ì„¸ìš”.
- ì•„ë˜ ì˜ˆì‹œëŠ” ì°¾ê³ ì í•˜ëŠ” ì •ë³´ê°€ 5ê°œì¸ ì˜ˆì‹œì…ë‹ˆë‹¤ í˜¼ë™í•˜ì§€ ë§ˆì„¸ìš”. 
ì˜ˆì‹œ) BRCA1, DNA ì†ìƒ ë³µêµ¬, ì„¸í¬ ì£¼ê¸° ì¡°ì ˆ ì¦ê°€, F, ì„¸í¬ ì£¼ê¸° ì •ì§€, T
`;

  promptBox.value = template;
});





// âœ… GPT ìš”ì²­ ì‹œì‘
let isRunning = false;
let isStopped = false;

sendToGptBtn.addEventListener("click", async () => {
  if (isRunning) {
    // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´: ì¤‘ë‹¨ ìš”ì²­
    isStopped = true;
    logToConsole("ğŸš¨ ì¤‘ë‹¨ ìš”ì²­ë¨...");
    sendToGptBtn.disabled = true;  // ì¤‘ë‹¨ ìš”ì²­ í›„ ì ì‹œ ë¹„í™œì„±í™”
    return;
  }

  // ì‹¤í–‰ ì‹œì‘
  isRunning = true;
  isStopped = false;
  sendToGptBtn.textContent = "â¹ ì¤‘ë‹¨";
  sendToGptBtn.classList.add("running");

  const apiKey = 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;
  const model = gpt-4o-mini;
  const searchArea = document.getElementById("searcharea").value.trim();
  const promptTemplate = promptBox.value.trim();
  const searchItems = searchListEl.value.trim().split(/\n+/);

  if (!apiKey || !model || !promptTemplate || !searchArea || !searchItems.length) {
    alert("ëª¨ë“  ì…ë ¥ í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.");
    resetButton();
    return;
  }

  geneData = [];




// âœ… ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ CSV ì €ì¥ ì‹¤í–‰
  const downloadBtn = document.getElementById("csvDownload");
  if (downloadBtn) downloadBtn.style.display = "none";

  logToConsole("âœ… GPT ìš”ì²­ ì‹œì‘...");

  for (const gene of searchItems) {
    if (isStopped) {
      logToConsole("â¹ï¸ ì‘ì—…ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
      break;
    }

    const response = await getGeneInfo(gene, promptTemplate, apiKey, model, searchArea);
    const values = response.split(/\s*,\s*/);
	// âœ… ëˆ„ë½ëœ í•­ëª©ì€ 'ì •ë³´ì—†ìŒ'ìœ¼ë¡œ ì±„ì›Œì„œ í•„ë“œ ìˆ˜ ë§ì¶¤
    while (values.length < document.getElementById("targetFields").value.trim().split(/\n+/).length + 1) {
      values.push("ì •ë³´ì—†ìŒ");
    }

    geneData.push(values.slice(1));
  }

if (geneData.length > 0 && downloadBtn) {
  if (isStopped) {
    logToConsole("â¹ï¸ ì¤‘ë‹¨ë˜ì—ˆì§€ë§Œ, ì™„ë£Œëœ í•­ëª©ì€ ì €ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  } else {
    logToConsole("âœ… ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ ì €ì¥í•˜ì„¸ìš”.");
  }
  downloadBtn.style.display = "block";
}

resetButton();

});


// âœ… ë²„íŠ¼ ìƒíƒœ ì›ë³µ í•¨ìˆ˜
function resetButton() {
  isRunning = false;
  isStopped = false;
  sendToGptBtn.disabled = false;
  sendToGptBtn.textContent = "GPTì— ì „ì†¡";
  sendToGptBtn.classList.remove("running");
}




// âœ… ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
downloadBtn.addEventListener("click", downloadCSV);

// âœ…ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
function logToConsole(message) {
  const consoleEl = document.getElementById("console");
  consoleEl.textContent += `\n${message}`;
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

// âœ…ìˆ˜ì •ëœ GPT í˜¸ì¶œ í•¨ìˆ˜
async function getGeneInfo(gene, promptTemplate, apiKey, model, searchArea) {
  const maxRetries = 2; // ì¬ì‹œë„ 2ë²ˆ, ì´ 3ë²ˆ ìš”ì²­
  const systemMessage = `${searchArea} ì „ë¬¸ê°€ì…ë‹ˆë‹¤.`;
  const prompt = promptTemplate.replace(/\{?input items\}?/g, gene);


  let bestResult = null;
  let bestNoneCount = Infinity;

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { role: "system", content: systemMessage },
            { role: "user", content: prompt },
          ],
        }),
      });

      if (!response.ok) {
        const errData = await response.json();
        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${errData.error?.message || response.statusText}`);
      }

      const data = await response.json();

      let result;
      if (data.choices && data.choices[0]) {
        if (data.choices[0].message && data.choices[0].message.content) {
          result = data.choices[0].message.content.trim();
        } else if (data.choices[0].text) {
          result = data.choices[0].text.trim();
        } else {
          throw new Error("API ì‘ë‹µì— ë©”ì‹œì§€ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        }
      } else {
        throw new Error("API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }

      // GPT ì¶œë ¥ê°’ ë¡œê·¸ì— ì¶œë ¥
      logToConsole(`GPT ì¶œë ¥ [${gene}] (ì‹œë„ ${attempt+1}): ${result}`);

      // 'ì •ë³´ì—†ìŒ' í¬í•¨ ê°œìˆ˜ ì„¸ê¸°
      const noneCount = (result.match(/ì •ë³´ì—†ìŒ/g) || []).length;

      if (noneCount === 0) {
        // ì •ë³´ì—†ìŒ ì—†ìœ¼ë©´ ë°”ë¡œ return
        return result;
      }

      // ì •ë³´ì—†ìŒ ê°œìˆ˜ê°€ ì§€ê¸ˆê¹Œì§€ ê°€ì¥ ì ìœ¼ë©´ ì €ì¥
      if (noneCount < bestNoneCount) {
        bestNoneCount = noneCount;
        bestResult = result;
      }

      // ì¬ì‹œë„ ê°€ëŠ¥í•˜ë©´ 1ì´ˆ ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹œë„ (optional)
      if (attempt < maxRetries) {
        await new Promise(res => setTimeout(res, 1000));
      }

    } catch (error) {
      logToConsole(`âŒ ${gene} - ì˜¤ë¥˜ ë°œìƒ: ${error.message || error}`);
      // ì—ëŸ¬ ë°œìƒ ì‹œë„ ì¬ì‹œë„ëŠ” ì•ˆí•¨, ë°”ë¡œ break
      break;
    }
  }

  // ìµœëŒ€ ì¬ì‹œë„ í›„ ê°€ì¥ ì •ë³´ì—†ìŒ ì ì€ ê²°ê³¼ ë°˜í™˜ ë˜ëŠ” ê¸°ë³¸ ë¬¸êµ¬
  if (bestResult) {
    logToConsole(`âš ï¸ ${gene} - ì •ë³´ì—†ìŒ í¬í•¨ëœ ê²°ê³¼ ì¤‘ ìµœì  ì„ íƒ (ì •ë³´ì—†ìŒ ${bestNoneCount}ê°œ)`);
    return bestResult;
  } else {
    return `${gene}, APIì˜¤ë¥˜ ë°œìƒ, ì •ë³´ì—†ìŒ, ì •ë³´ì—†ìŒ, ì •ë³´ì—†ìŒ, ì •ë³´ì—†ìŒ`;
  }
}





</script>
</body>
</html>
